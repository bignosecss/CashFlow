# CashFlow 手机 App 开发计划

## 1. 项目目标与当前进度

- **项目目标**: 构建一个能多端同步、离线可用的个人记账工具，具备基本财务分析能力。
- **当前进度**: 主页 (HomeScreen) 和添加账单页 (AddBillScreen) 的 UI 已完成。
- **待重写部分**: SQLite 数据库交互层。

## 2. MVP 功能回顾 (基于 Notion 文档)

- **记账功能**: 添加账单 (金额、分类、备注、时间)、查看账单列表。
- **数据分析**: 月收支汇总 (饼图/条形图)、分类统计。
- **同步能力**: 离线保存 (写入 SQLite)、联网后上传 (调用 sync API)。

## 3. 后续开发需求与步骤

基于当前进度和 MVP 功能，后续手机 App 开发主要集中在数据层重写、数据同步逻辑实现以及分析页面的开发。

### 3.1. 用户认证 (登录/注册)

- **需求**: 实现用户登录、注册、会话管理和权限控制。
- **优先级**: 高
- **原因**: 数据安全、个性化体验、权限控制。
- **步骤**:
  1. 设计并实现登录/注册 UI 界面。
  2. 集成后端认证 API (参考 Web 端 API 合约)。
  3. 使用安全存储方案 (如 react-native-keychain) 存储用户凭证/Token。
  4. 利用 Zustand 管理全局认证状态。
  5. 实现路由守卫，保护需要认证的页面。
  6. 处理认证相关的错误和用户反馈。
  7. 考虑离线状态下的行为 (可选，初期可忽略)。

### 3.2. 数据库层重写与数据模型定义

- **需求**: 重写 `/src/database` 目录下的 SQLite 交互代码，使其清晰、健壮，并符合项目规范。需要考虑如何关联和隔离不同用户的数据。
- **步骤**:
  1. 定义清晰的 TypeScript 数据模型接口 (例如 `Bill`, `Category`)。
  2. 设计 SQLite 数据库表结构，与数据模型对应，包含用户关联字段。
  3. 实现数据库初始化函数，包括创建表。
  4. 实现账单的 CRUD (Create, Read, Update, Delete) 异步函数，确保参数绑定防止 SQL 注入，并考虑用户 ID 作为查询条件。
  5. 实现分类的读取函数，考虑用户 ID。
  6. 考虑数据版本或时间戳字段，为后续同步做准备。

### 3.2. 状态管理与数据流

- **需求**: 利用 Zustand 管理应用状态，包括账单列表、分类数据、同步状态等。
- **步骤**:
  1. 更新或重构 `/src/store` 中的 Zustand store。
  2. 在 store 中集成新的数据库操作函数。
  3. 设计状态更新逻辑，确保 UI 与本地数据库同步。
  4. 考虑同步状态的管理 (例如 `isSyncing`, `lastSyncTime`)。

### 3.3. 主页 (HomeScreen) 功能完善

- **需求**: 连接 UI 与新的数据层和状态管理，展示账单列表，实现日期范围切换和总收支计算。
- **步骤**:
  1. 在 HomeScreen 中使用 Zustand store 获取账单数据。
  2. 实现按日期范围过滤账单的逻辑。
  3. 计算并展示当前日期范围内的总支出和总收入。
  4. 优化列表渲染性能 (使用 `FlatList`, `keyExtractor`, `getItemLayout`)。
  5. 实现点击账单项查看详情或修改/删除的功能 (如果包含在 MVP 内)。

### 3.4. 添加账单页 (AddBillScreen) 功能完善

- **需求**: 连接 UI 与新的数据层和状态管理，实现账单数据的输入、分类选择、日期选择和保存。
- **步骤**:
  1. 在 AddBillScreen 中使用 Zustand store 或 hooks 处理表单输入。
  2. 集成分类选择功能 (从数据库读取分类数据)。
  3. 集成日期选择功能。
  4. 调用新的数据库函数保存账单数据。
  5. 保存成功后更新 Zustand 状态并导航回主页。

### 3.5. 分析页 (AnalyticsScreen) 开发

- **需求**: 开发数据分析页面，展示月收支汇总和分类统计图表。
- **步骤**:
  1. 在 AnalyticsScreen 中使用 Zustand store 获取账单数据。
  2. 实现数据处理逻辑，计算月总收支和各分类支出/收入总额。
  3. 选择合适的图表库 (已引入 `react-native-gifted-charts`) 绘制图表 (饼图、条形图)。
  4. 实现按月切换分析数据的功能。

### 3.6. 数据同步机制实现

- **需求**: 实现 App 与后端 Sync API 的数据同步逻辑。
- **步骤**:
  1. 设计本地数据变更追踪机制 (例如，在 SQLite 中标记变更或使用单独的变更日志表)。
  2. 实现异步同步函数，检测网络状态。
  3. 联网时，将本地变更上传到 Sync API (`POST /sync`)。
  4. 处理 Sync API 返回的远程变更，合并到本地 SQLite 数据库。
  5. 处理数据冲突 (MVP 阶段可简化，后续迭代完善)。
  6. 在 App 启动或特定事件触发时执行同步。
  7. 在 UI 中展示同步状态。

## 4. 性能与类型安全

- **性能**: 持续关注列表渲染、数据处理和同步过程的性能，避免阻塞 JS 线程。考虑使用 Worklets 或 Native Modules 处理复杂数据同步逻辑。
- **类型安全**: 严格使用 TypeScript 定义所有数据结构、函数参数和返回值，特别是数据库交互和 Sync API 接口。

## 5. 测试

- 为数据库操作函数、Zustand store actions 和同步逻辑编写单元测试 (Jest)。

## 6. 总结

接下来的重点是重写数据库层，并在此基础上实现数据同步、分析页面和用户认证的功能。严格遵循模块化设计和性能优化原则，确保应用的可维护性和流畅性。